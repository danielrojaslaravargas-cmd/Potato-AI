import streamlit as st
from google import genai

# --- 1. SECURITY SETUP ---
# On Streamlit Cloud, you will put your key in "Settings > Secrets"
# For testing locally, you can replace this with: API_KEY = "YOUR_KEY_HERE"
try:
    API_KEY = st.secrets["GEMINI_API_KEY"]
except:
    API_KEY = "AIzaSyAR3wLcR4yLwHXLmJAavohHjaE3O5gVDUg" 

client = genai.Client(api_key=API_KEY)
SYSTEM_PROMPT = "You are Potato AI. You are a helpful assistant and a potato. Use puns like 'spud-tacular' and 'starch'. Remember user details."

# --- 2. THE UI STYLING ---
st.set_page_config(page_title="POTATO AI ðŸ¥”", layout="centered")

st.markdown("""
    <style>
    .stApp { background-color: #050805; color: #f0fff0; }
    .stChatMessage { border-radius: 25px; border: 2px solid #2e7d32; }
    .stProgress > div > div > div > div { background-color: #81c784; }
    </style>
    """, unsafe_allow_html=True)

# --- 3. MEMORY SYSTEM ---
if "messages" not in st.session_state:
    st.session_state.messages = []

if "soil_level" not in st.session_state:
    st.session_state.soil_level = 0

# --- 4. INTERFACE ---
st.title("POTATO AI ðŸ¥”")
st.write(f"Soil Level: {st.session_state.soil_level}%")
st.progress(st.session_state.soil_level / 100)

for message in st.session_state.messages:
    with st.chat_message(message["role"]):
        st.markdown(message["content"])

# --- 5. CHAT LOGIC ---
if prompt := st.chat_input("Say something earthy..."):
    st.session_state.messages.append({"role": "user", "content": prompt})
    with st.chat_message("user"):
        st.markdown(prompt)

    try:
        response = client.models.generate_content(
            model="gemini-1.5-flash",
            config={"system_instruction": SYSTEM_PROMPT},
            contents=[{"role": m["role"], "parts": [{"text": m["content"]}]} for m in st.session_state.messages]
        )
        
        full_response = response.text
        with st.chat_message("assistant"):
            st.markdown(full_response)
        st.session_state.messages.append({"role": "assistant", "content": full_response})
        
        st.session_state.soil_level = (st.session_state.soil_level + 20) % 120
        if st.session_state.soil_level > 100:
            st.balloons()
            st.session_state.soil_level = 0
            
    except Exception as e:
        st.error(f"Root error: {e}")